<div class="client-tickets-container">
  <!-- Success Message -->
  <div *ngIf="success()" class="success-message">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
    {{ success() }}
  </div>

  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ 'ticketsClient.title' | translate }}</h1>
      <p class="page-subtitle">{{ 'ticketsClient.subtitle' | translate }}</p>
    </div>
    <div class="header-actions">
      <button class="create-ticket-btn" (click)="openModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
        {{ 'ticketsClient.create' | translate }}
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
          <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path
            d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
            stroke="currentColor"
            stroke-width="2"
          />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ tickets().length }}</div>
        <div class="stat-label">{{ 'ticketsClient.stats.total' | translate }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
          <path
            d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z"
            stroke="currentColor"
            stroke-width="2"
          />
          <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getOpenTickets() }}</div>
        <div class="stat-label">{{ 'ticketsClient.stats.open' | translate }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
          <path
            d="M22 11.08V12A10 10 0 1 1 5.68 3.49"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-number">{{ getResolvedTickets() }}</div>
        <div class="stat-label">{{ 'ticketsClient.stats.resolved' | translate }}</div>
      </div>
    </div>
  </div>

  <!-- Tickets List -->
  <div class="tickets-section">
    <div class="section-header">
      <h2>{{ 'ticketsClient.history' | translate }}</h2>
      <div class="filters">
        <select class="filter-select" [(ngModel)]="statusFilter" (change)="filterTickets()">
          <option value="">{{ 'ticketsClient.filters.all' | translate }}</option>
          <option value="Nouveau">{{ 'ticketsClient.filters.status.nouveau' | translate }}</option>
          <option value="En cours">{{ 'ticketsClient.filters.status.enCours' | translate }}</option>
          <option value="Résolu">{{ 'ticketsClient.filters.status.resolu' | translate }}</option>
          <option value="En attente de paiement">{{ 'ticketsClient.filters.status.enAttentePaiement' | translate }}</option>
          <option value="Paiement validé">{{ 'ticketsClient.filters.status.paiementValide' | translate }}</option>
          <option value="Fermé">{{ 'ticketsClient.filters.status.ferme' | translate }}</option>
          <option value="Urgent">{{ 'ticketsClient.filters.status.urgent' | translate }}</option>
        </select>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-state">
      <div class="loading-spinner"></div>
      <p>{{ 'ticketsClient.loading' | translate }}</p>
    </div>

    <!-- Tickets Grid -->
    <div *ngIf="!loading() && filteredTickets().length" class="tickets-grid">
      <div *ngFor="let ticket of filteredTickets()" class="ticket-card" (click)="openTicketDetail(ticket)">
        <div class="ticket-header">
          <div class="ticket-type-badge" [ngClass]="'type-' + (ticket.type.toLowerCase() || 'autre')">
            {{ getTicketTypeTranslation(ticket.type) }}
          </div>
          <div class="ticket-status-badge" [ngClass]="'status-' + (ticket.status?.toLowerCase() || 'nouveau')">
            {{ getTicketStatusTranslation(ticket.status) }}
          </div>
        </div>

        <div class="ticket-content">
          <h3 class="ticket-description">{{ ticket.description }}</h3>

          <!-- Indicateur de messages de l'admin -->
          <div *ngIf="ticket.messageStrings && ticket.messageStrings.length > 0" class="admin-messages-indicator">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path
                d="M8 12h8m-8 4h4m-4-8h8M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
            <span>{{ getAdminMessagesLabel(ticket.messageStrings.length) }}</span>
          </div>

          <div class="ticket-meta">
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
              <span>{{ ticket.createdDate | date: 'short' }}</span>
            </div>

            <div *ngIf="ticket.backofficeUrl" class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              <span>{{ 'ticketsClient.meta.backoffice' | translate }}</span>
            </div>

            <div *ngIf="ticket.hostingUrl" class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path
                  d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              <span>{{ 'ticketsClient.meta.hosting' | translate }}</span>
            </div>
          </div>
        </div>

        <div class="ticket-footer">
          <span class="view-details">{{ 'ticketsClient.viewDetails' | translate }}</span>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading() && !filteredTickets().length" class="empty-state">
      <div class="empty-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
          <path
            d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.0391C19.7893 20.7893 20 20.5304 20 20V8L14 2Z"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <h3>{{ 'ticketsClient.empty.title' | translate }}</h3>
      <p>{{ 'ticketsClient.noTickets' | translate }}</p>
      <button class="create-first-ticket-btn" (click)="openModal()">{{ 'ticketsClient.empty.cta' | translate }}</button>
    </div>
  </div>

  <!-- Create Ticket Modal -->
  <div *ngIf="showModal()" class="modal-overlay" (click)="closeModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'ticketsClient.create' | translate }}</h3>
        <button class="modal-close-btn" (click)="closeModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>

      <form [formGroup]="ticketForm" (ngSubmit)="submit()" class="ticket-form">
        <div class="form-row">
          <div class="form-group">
            <label for="type">{{ 'ticketsClient.type' | translate }} *</label>
            <select id="type" formControlName="type" required class="form-select">
              <option value="" disabled>{{ 'ticketsClient.selectType' | translate }}</option>
              <option value="Bug">{{ 'ticketsClient.types.bug' | translate }}</option>
              <option value="Demande">{{ 'ticketsClient.types.demande' | translate }}</option>
              <option value="Support">{{ 'ticketsClient.types.support' | translate }}</option>
              <option value="Autre">{{ 'ticketsClient.types.autre' | translate }}</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="description">{{ 'ticketsClient.description' | translate }} *</label>
          <textarea
            id="description"
            formControlName="description"
            required
            rows="4"
            class="form-textarea"
            [placeholder]="'ticketsClient.form.ticketPlaceholder' | translate"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="imageUpload">{{ 'ticketsClient.image.label' | translate }}</label>
          <div class="image-upload-container">
            <input
              type="file"
              id="imageUpload"
              formControlName="image"
              accept="image/*"
              class="file-input"
              (change)="onImageSelected($event)"
              #fileInput
            />
            <div class="upload-area" (click)="fileInput.click()" [class.has-image]="selectedImagePreview()">
              <div *ngIf="!selectedImagePreview()" class="upload-placeholder">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M21 19V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <p>{{ 'ticketsClient.image.add' | translate }}</p>
                <span class="upload-hint">{{ 'ticketsClient.image.hint' | translate }}</span>
              </div>
              <div *ngIf="selectedImagePreview()" class="image-preview">
                <img
                  [src]="selectedImagePreview()"
                  [alt]="'ticketsClient.image.previewAlt' | translate"
                  class="preview-image"
                  width="200"
                  height="150"
                />
                <button type="button" class="remove-image-btn" (click)="removeImage($event)">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </button>
              </div>
            </div>
            <div *ngIf="uploadProgress() > 0 && uploadProgress() < 100" class="upload-progress">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="uploadProgress()"></div>
              </div>
              <span class="progress-text">{{ uploadProgress() }}%</span>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>{{ 'ticketsClient.form.backofficeSection' | translate }}</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="backofficeUrl">{{ 'ticketsClient.backofficeUrl' | translate }}</label>
              <input
                id="backofficeUrl"
                formControlName="backofficeUrl"
                type="url"
                class="form-input"
                [placeholder]="'ticketsClient.info.backofficeUrlPlaceholder' | translate"
              />
            </div>
            <div class="form-group">
              <label for="backofficeLogin">{{ 'ticketsClient.backofficeLogin' | translate }}</label>
              <input
                id="backofficeLogin"
                formControlName="backofficeLogin"
                type="text"
                class="form-input"
                [placeholder]="'ticketsClient.info.loginPlaceholder' | translate"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="backofficePassword">{{ 'ticketsClient.backofficePassword' | translate }}</label>
            <input
              id="backofficePassword"
              formControlName="backofficePassword"
              type="password"
              class="form-input"
              [placeholder]="'ticketsClient.info.passwordPlaceholder' | translate"
            />
          </div>
        </div>

        <div class="form-group">
          <label for="hostingUrl">{{ 'ticketsClient.hostingUrl' | translate }}</label>
          <input
            id="hostingUrl"
            formControlName="hostingUrl"
            type="url"
            class="form-input"
            [placeholder]="'ticketsClient.info.hostingUrlPlaceholder' | translate"
          />
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeModal()">
            {{ 'ticketsClient.cancel' | translate }}
          </button>
          <button type="submit" class="btn-primary" [disabled]="ticketForm.invalid || loading()">
            <span *ngIf="!loading()">{{ 'ticketsClient.create' | translate }}</span>
            <span *ngIf="loading()">{{ 'ticketsClient.form.creating' | translate }}</span>
          </button>
        </div>

        <div *ngIf="error()" class="error-message">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          {{ error() }}
        </div>
      </form>
    </div>
  </div>

  <!-- Modal pour créer un devis -->
  <div *ngIf="showDevisModal()" class="modal-overlay" (click)="closeDevisModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'ticketsClient.devis.title' | translate }}</h3>
        <button class="modal-close-btn" (click)="closeDevisModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <div class="form-group">
          <label for="devisAmount">{{ 'ticketsClient.devis.amount' | translate }}</label>
          <input type="number" id="devisAmount" [(ngModel)]="devisAmount" class="form-control" placeholder="0.00" min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label for="devisDescription">{{ 'ticketsClient.devis.description' | translate }}</label>
          <textarea
            id="devisDescription"
            [(ngModel)]="devisDescription"
            class="form-control"
            rows="4"
            [placeholder]="'ticketsClient.form.devisPlaceholder' | translate"
          ></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDevisModal()">
            {{ 'ticketsClient.devis.cancel' | translate }}
          </button>
          <button type="button" class="btn btn-primary" (click)="submitDevis()">{{ 'ticketsClient.devis.submit' | translate }}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour valider le paiement -->
  <div *ngIf="showPaymentValidationModal()" class="modal-overlay" (click)="closePaymentValidationModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'ticketsClient.payment.title' | translate }}</h3>
        <button class="modal-close-btn" (click)="closePaymentValidationModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </div>
      <div class="modal-content">
        <div class="payment-validation-info">
          <p>{{ 'ticketsClient.payment.confirm' | translate }}</p>
          <div class="ticket-info">
            <strong>{{ 'ticketsClient.payment.ticketLabel' | translate: { id: selectedTicketForPayment?.id } }}</strong
            ><br />
            <span>{{ selectedTicketForPayment?.type }} - {{ selectedTicketForPayment?.description }}</span>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closePaymentValidationModal()">
            {{ 'ticketsClient.payment.cancel' | translate }}
          </button>
          <button type="button" class="btn btn-success" (click)="validatePayment(selectedTicketForPayment!.id!)">
            {{ 'ticketsClient.payment.validate' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div *ngIf="showImageModal()" class="modal-overlay" (click)="closeImageModal()">
    <div class="image-modal-container" (click)="$event.stopPropagation()">
      <button class="image-modal-close-btn" (click)="closeImageModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
      <img
        [src]="selectedImageUrl()"
        [alt]="'ticketsClient.image.previewAlt' | translate"
        class="full-size-image"
        width="800"
        height="600"
      />
    </div>
  </div>
</div>
